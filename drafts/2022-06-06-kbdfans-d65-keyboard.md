---
tags: keyboard, qmk, via
---

# Клавиатура KBDfans D65

В начале 2022 года я стал обладателем клавиатуры [KBDfans D65][1]. Долго выбирал
какую клавиатуру я бы хотел себе приобрести и в итоге остановился на этой.
Использую ее как основную клавиатуру.

Приобретал все на AliExpress:
- [Корпус цвета Violet Purple][2]
- Свитчи Gateron Zealio*s* V2:
  + Сначала взял на [62 грамма][3]
  + Позже заменил на [67 грамм][4]
- Клавиши [EnjoyPBT Milky&Purple Doubleshot][5]

Взял еще улучшателей:
- Пленки для свитчей [KBDfans Transparent][6] (их хватило на два набора свитчей)
- Масло [Keychron Klube 105][7]
- Смазка [Permatex 81150][8]


## Сборка

Сборку проводил по [инструкции][9] с официального сайта KBDfans. Сам процесс не
вызвал никаких сложностей. Был очень долгий и утомительный процесс смазывания
свитчей, он у меня занял два вечера. У меня не было специализированного
инструмента для разборки свитчей, поэтому в один вечер аккуратно, чтобы не
сломать вскрывал свитч, извлекал пружинку и шток, раскладывал их в разные
коробочки. А в другой вечер также аккуратно смазывал шток, чтобы не задеть его
ножки, изнутри смазывал направляющие в свитче, укладывал уплотняющую пленку и
закрывал свитч.

## Конфигурация

Управлять конфигурацией клавиатуры можно с помощью утилиты [VIA][10].
Поигрался и оставил все как есть. При использовании клавиатуры сразу же поймал
проблему, что при установленном переключении языков на Caps Lock в MacOS
происходит переключение языка и состояния Caps Lock. То есть переключаясь с
русского на английский я получу то, что все набираемые символы будут в верхнем
регистре. Состояние Caps Lock приходилось отключать отдельно. Но учитывая, что
приходится переключаться между языками очень часто это становилось серьезной
проблемой использования.

Оказалось, что эта проблема связана с таймерами, которые выдает родная прошивка
VIA - [описание проблемы][11]. И эту проблему решили в прошивке QMK.


Стандартная прошивка QMK не поддерживает управление с помощью VIA. Для этого
надо внести изменения в конфигурацию - включить [VIA_ENABLE][12]. И заодно,
чтобы уменьшить размер получаемого бинарного файла прошивки, надо включить
[LTO_ENABLE][13]. Как пишут в документации, время сборки увеличится, но
значительно уменьшит размер файла прошивки.

Если нет необходимости включать поддержку VIA, то готовую прошивку можно
получить онлайн - [QMK конфигуратор для KBDfans D65][14]. Если же хочется
поддержки VIA, то надо будет самостоятельно компилировать прошивку. А из онлайн
конфигуратора можно забрать файл `keymap.json`, чтобы добавить его в свою
прошивку.

Полный процесс подготовки окружения, компиляции файла прошивки и загрузка новой
прошивки в клавиатуру описаны в [документации QMK][15].

Мой набор команд для компиляции прошивки был такой:
```bash
# Перехожу в корневую директорию qmk firmware
qmk cd
# Указываю клавиатуру
qmk config user.keyboard=kbdfans/kbd67/mkiirgb/v3
# Даю название раскладке
qmk config user.keymap=sattellite
# Создаю директории раскладки
qmk new-keymap -kb=kbdfans/kbd67/mkiirgb/v3
# Генерирую файл с раскладкой из скачанного из конфигуратора файла
qmk json2c -o keyboards/kbdfans/kbd67/mkiirgb/keymaps/sattellite/keymap.c ~/Downloads/keymap.json
# Добавляю поддержку via
cat > keyboards/kbdfans/kbd67/mkiirgb/keymaps/sattellite/rules.mk << EOF
VIA_ENABLE = yes
LTO_ENABLE = yes
EOF
## Компилирую прошивку
qmk compile -kb=kbdfans/kbd67/mkiirgb/v3 -km=sattellite
```

Итоговый файл помещается в корневую директорию qmk firmware. Оттуда его можно
взять и загрузить в клавиатуру. Предварительно файл надо переименовать в
`FLASH.BIN`.

## Моя прошивка

Свою прошивку разместил на [github][16], и рядом положил изображения каждого
слоя, чтобы не забылись.


[1]:  https://kbdfans.com/products/icd65-mechanical-keyboard-kit
[2]:  https://aliexpress.com/item/1005002300724821.html
[3]:  https://aliexpress.com/item/1005002050402909.html?sku_id=12000018558464849
[4]:  https://aliexpress.com/item/1005002050402909.html?sku_id=12000018558471873
[5]:  https://aliexpress.com/item/1005003504374566.html
[6]:  https://aliexpress.com/item/1005002147892603.html?sku_id=12000018890780033
[7]:  https://aliexpress.com/item/1005003226619341.html?sku_id=12000024746449222
[8]:  https://aliexpress.com/item/1005003318129422.html
[9]:  https://shimo.im/docs/GxgK8YQX9pCcHqwh/read
[10]: https://www.caniusevia.com
[11]: https://github.com/the-via/keyboards/issues/551
[12]: https://www.caniusevia.com/docs/configuring_qmk#create-a-via-keymap-directory-and-files-in-qmk-source
[13]: https://github.com/qmk/qmk_firmware/blob/master/docs/config_options.md
[14]: https://config.qmk.fm/#/kbdfans/kbd67/mkiirgb/v3/LAYOUT_65_ansi_blocker
[15]: https://docs.qmk.fm/#/newbs
[16]: https://github.com/sattellite/keyboard/tree/main/kbdfans/d65
