---
tags: sip, voip
noedit: true
---

# Алгоритм установления SIP соединения

Протоколом SIP предусмотрены 3 основных сценария установления соединения: с участием прокси-сервера, с участием сервера переадресации и непосредственно между пользователями. Различие между перечисленными сценариями заключается в том, что по-разному осуществляется поиск и приглашение вызываемого пользователя. В первом случае эти функции возлагает на себя прокси-сервер, а вызывающему пользователю необходимо знать только постоянный SIP-адрес вызываемого пользователя. Во втором случае вызывающая сторона самостоятельно устанавливает соединение, а сервер переадресации лишь реализует преобразование постоянного адреса вызываемого абонента в его текущий адрес. И, наконец, в третьем случае вызывающему пользователю для установления соединения необходимо знать текущий адрес вызываемого пользователя.

Перечисленные сценарии являются простейшими. Ведь прежде чем вызов достигнет адресата, он может пройти через несколько прокси-серверов, или сначала направляется к серверу переадресации, а затем проходит через один или несколько прокси-серверов. Кроме того, прокси-серверы могут размножать запросы и передавать их по разным направлениям и т.д. Но, все же, как уже было уже отмечено, эти три сценария являются основными.

### Установление соединения с участием прокси-сервера

Администратор сети сообщает адрес прокси-сервера пользователям. Вызывающий пользователь передает запрос INVITE на адрес прокси-сервера и порт 5060, используемый по умолчанию. В запросе пользователь указывает известный ему адрес вызываемого пользователя. Прокси-сервер запрашивает текущий адрес вызываемого пользователя у сервера определения местоположения, который и сообщает ему этот адрес. Далее прокси-сервер отвечает 100 Trying, сообщая о том, что пошел процесс установления сессии и передает запрос INVITE непосредственно вызываемому оборудованию. Опять в запросе содержатся данные о функциональных возможностях вызывающего терминала, но при этом в запрос добавляется поле Via с адресом прокси-сервера для того, чтобы ответы на обратном пути шли через него. После приема и обработки запроса вызываемое оборудование сообщает своему пользователю о входящем вызове, а встречной стороне передает ответ 180 Ringing, копируя в него из запроса поля То, From, Call-ID, CSeq и Via. После приема вызова пользователем встречной стороне передается сообщение 200 OK, содержащее данные о функциональных возможностях вызываемого терминала в формате протокола SDP. Терминал вызывающего пользователя подтверждает прием ответа запросом АСК. На этом фаза установления соединения закончена и начинается разговорная фаза.
По завершении разговорной фазы одной из сторон передается запрос BYE, который подтверждается ответом 200 OK.
Все сообщения проходят через прокси-сервер, который может модифицировать в них некоторые поля.

![](/images/sip-scheme.png)


